Sub ProcessAllData()
    Dim wsPortfolio As Worksheet
    Dim wbMaster As Workbook
    Dim wbTrigger As Workbook, wbAllFunds As Workbook, wbNonTrigger As Workbook
    Dim triggerFile As String, allFundsFile As String, nonTriggerFile As String
    Dim triggerSheet As Worksheet, allFundsSheet As Worksheet, nonTriggerSheet As Worksheet
    Dim triggerTable As ListObject, portfolioTable As ListObject, allFundsTable As ListObject, nonTriggerTable As ListObject
    Dim dictFundGCI As Object
    Dim fundGCIArray As Variant, resultArray As Variant
    Dim i As Long, lastRowPortfolio As Long
    Dim fundGCICol As Range, iaGCICol As Range

    ' Set up the Portfolio sheet
    Set wbMaster = ThisWorkbook
    Set wsPortfolio = wbMaster.Sheets("Portfolio")

    ' Ensure the Portfolio sheet is converted to a table
    On Error Resume Next
    Set portfolioTable = wsPortfolio.ListObjects("PortfolioTable")
    On Error GoTo 0
    If portfolioTable Is Nothing Then
        ' Convert the range to a table if not already one
        Set portfolioTable = wsPortfolio.ListObjects.Add(xlSrcRange, wsPortfolio.UsedRange, , xlYes)
        portfolioTable.Name = "PortfolioTable"
    End If

    ' Clear existing data in the Portfolio table except headers
    If Not portfolioTable.DataBodyRange Is Nothing Then
        portfolioTable.DataBodyRange.ClearContents
    End If

    ' Step 1: Process Trigger.csv
    triggerFile = Application.GetOpenFilename("CSV Files (*.csv), *.csv", , "Select Trigger.csv")
    If triggerFile = "False" Then Exit Sub ' User canceled

    Set wbTrigger = Workbooks.Open(triggerFile)
    Set triggerSheet = wbTrigger.Sheets(1)

    ' Convert Trigger data to a table if it isn't already one
    On Error Resume Next
    Set triggerTable = triggerSheet.ListObjects(1)
    On Error GoTo 0
    If triggerTable Is Nothing Then
        Set triggerTable = triggerSheet.ListObjects.Add(xlSrcRange, triggerSheet.UsedRange, , xlYes)
        triggerTable.Name = "TriggerTable"
    End If

    ' Copy specific columns from Trigger.csv to Portfolio
    Dim headers As Variant
    Dim pasteStartRow As Long
    headers = Array("Region", "Fund Manager", "Fund GCI", "Fund Name", "Wks Missing", "Credit Officer")
    pasteStartRow = portfolioTable.HeaderRowRange.Row + 1
    For i = LBound(headers) To UBound(headers)
        With triggerTable.ListColumns(headers(i)).DataBodyRange
            wsPortfolio.Cells(pasteStartRow, portfolioTable.ListColumns(headers(i)).Index).Resize(.Rows.Count, 1).Value = .Value
        End With
    Next i

    ' Replace Region values and populate Trigger/Non-Trigger column
    With portfolioTable.DataBodyRange
        Dim regionColIndex As Long, triggerColIndex As Long
        regionColIndex = portfolioTable.ListColumns("Region").Index
        triggerColIndex = portfolioTable.ListColumns("Trigger/Non-Trigger").Index

        .Columns(regionColIndex).Replace What:="US", Replacement:="AMRS", LookAt:=xlWhole
        .Columns(regionColIndex).Replace What:="ASIA", Replacement:="APAC", LookAt:=xlWhole
        .Columns(triggerColIndex).Value = "Trigger"
    End With

    wbTrigger.Close SaveChanges:=False

    ' Step 2: Process All Funds.csv
    allFundsFile = Application.GetOpenFilename("CSV Files (*.csv), *.csv", , "Select all fund.csv")
    If allFundsFile = "False" Then Exit Sub ' User canceled

    Set wbAllFunds = Workbooks.Open(allFundsFile)
    Set allFundsSheet = wbAllFunds.Sheets(1)

    ' Delete the first row
    allFundsSheet.Rows(1).Delete

    ' Convert All Funds data to a table
    On Error Resume Next
    Set allFundsTable = allFundsSheet.ListObjects(1)
    On Error GoTo 0
    If allFundsTable Is Nothing Then
        Set allFundsTable = allFundsSheet.ListObjects.Add(xlSrcRange, allFundsSheet.UsedRange, , xlYes)
        allFundsTable.Name = "AllFundsTable"
    End If

    ' Filter Review Status to Approved
    allFundsTable.Range.AutoFilter Field:=allFundsTable.ListColumns("Review Status").Index, Criteria1:="Approved"

    ' Load Fund GCI and IA GCI from All Funds into a dictionary
    Set dictFundGCI = CreateObject("Scripting.Dictionary")
    Set fundGCICol = allFundsTable.ListColumns("Fund GCI").DataBodyRange
    Set iaGCICol = allFundsTable.ListColumns("IA GCI").DataBodyRange

    For i = 1 To fundGCICol.Rows.Count
        If Not IsEmpty(fundGCICol.Cells(i, 1).Value) And Not dictFundGCI.exists(fundGCICol.Cells(i, 1).Value) Then
            dictFundGCI.Add fundGCICol.Cells(i, 1).Value, iaGCICol.Cells(i, 1).Value
        End If
    Next i

    ' Match Fund GCI in Portfolio and write IA GCI to Fund Manager GCI
    lastRowPortfolio = portfolioTable.DataBodyRange.Rows.Count
    fundGCIArray = portfolioTable.ListColumns("Fund GCI").DataBodyRange.Value
    ReDim resultArray(1 To lastRowPortfolio, 1 To 1)

    For i = 1 To UBound(fundGCIArray, 1)
        If dictFundGCI.exists(fundGCIArray(i, 1)) Then
            resultArray(i, 1) = dictFundGCI(fundGCIArray(i, 1))
        Else
            resultArray(i, 1) = "No Match Found"
        End If
    Next i

    ' Write results back to Fund Manager GCI column
    portfolioTable.ListColumns("Fund Manager GCI").DataBodyRange.Value = resultArray

    ' Clear filters in All Funds table
    If allFundsTable.ShowAutoFilter Then allFundsTable.AutoFilter.ShowAllData

    wbAllFunds.Close SaveChanges:=False

    ' Step 3: Process Non-Trigger.csv
    nonTriggerFile = Application.GetOpenFilename("CSV Files (*.csv), *.csv", , "Select Non-Trigger.csv")
    If nonTriggerFile = "False" Then Exit Sub ' User canceled

    Set wbNonTrigger = Workbooks.Open(nonTriggerFile)
    Set nonTriggerSheet = wbNonTrigger.Sheets(1)

    ' Convert Non-Trigger data to a table
    On Error Resume Next
    Set nonTriggerTable = nonTriggerSheet.ListObjects(1)
    On Error GoTo 0
    If nonTriggerTable Is Nothing Then
        Set nonTriggerTable = nonTriggerSheet.ListObjects.Add(xlSrcRange, nonTriggerSheet.UsedRange, , xlYes)
        nonTriggerTable.Name = "NonTriggerTable"
    End If

    ' Filter out rows where FI-ASIA is present
    nonTriggerTable.Range.AutoFilter Field:=nonTriggerTable.ListColumns("Region").Index, Criteria1:="<>FI-ASIA"

    ' Append Non-Trigger data to Portfolio
    Dim sourceHeaders As Variant, destHeaders As Variant
    sourceHeaders = Array("Region", "Family", "Fund Manager GCI", "Fund Manager", "Fund GCI", "Fund Name", "Credit Officer", "Weeks Missing")
    destHeaders = Array("Region", "Family", "Fund Manager GCI", "Fund Manager", "Fund GCI", "Fund Name", "Credit Officer", "Wks Missing")

    lastRowPortfolio = portfolioTable.DataBodyRange.Rows.Count + portfolioTable.HeaderRowRange.Row

    For i = LBound(sourceHeaders) To UBound(sourceHeaders)
        With nonTriggerTable.ListColumns(sourceHeaders(i)).DataBodyRange
            wsPortfolio.Cells(lastRowPortfolio + 1, portfolioTable.ListColumns(destHeaders(i)).Index).Resize(.Rows.Count, 1).Value = .Value
        End With
    Next i

    ' Fill Trigger/Non-Trigger column with 'Non-Trigger'
    Dim triggerColIndex As Long
    triggerColIndex = portfolioTable.ListColumns("Trigger/Non-Trigger").Index
    With wsPortfolio
        .Range(.Cells(lastRowPortfolio + 1, triggerColIndex), .Cells(lastRowPortfolio + nonTriggerTable.ListRows.Count, triggerColIndex)).Value = "Non-Trigger"
    End With

    ' Clear filters in Non-Trigger table
    If nonTriggerTable.ShowAutoFilter Then nonTriggerTable.AutoFilter.ShowAllData

    wbNonTrigger.Close SaveChanges:=False

    MsgBox "Data from Trigger.csv, All Funds.csv, and Non-Trigger.csv has been processed successfully!", vbInformation
End Sub